name: Deploy Frontend to Oracle Cloud

on:
  push:
    branches: [ deploy ]
  pull_request:
    branches: [ deploy ]
    types: [closed]

jobs:
  deploy:
    # PRì´ mergeë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true || github.ref == 'refs/heads/deploy'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Install dependencies
      working-directory: ./front
      run: npm ci
      
    - name: Run type check
      working-directory: ./front
      run: npm run type-check
      
    - name: Run linter
      working-directory: ./front
      run: npm run lint || echo "ESLint warnings/errors found but continuing deployment"
      
    - name: Build application
      working-directory: ./front
      run: npm run build
      
    - name: Deploy to Oracle Cloud Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 134.185.106.160
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE }}
        port: 22
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p /var/www/frontend
          sudo chown -R $USER:$USER /var/www/frontend
          
          # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
          if [ -d "/var/www/frontend/backup" ]; then
            sudo rm -rf /var/www/frontend/backup
          fi
          if [ -d "/var/www/frontend/dist" ]; then
            sudo mv /var/www/frontend/dist /var/www/frontend/backup
          fi
          
          # ìƒˆë¡œìš´ ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /var/www/frontend/dist
          
    - name: Copy build files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: 134.185.106.160
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE }}
        port: 22
        source: "front/dist/*"
        target: "/var/www/frontend/"
        strip_components: 2
        
    - name: Setup Nginx (if not already configured)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 134.185.106.160
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE }}
        port: 22
        script: |
          # Nginx ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìœ¼ë©´ ìŠ¤í‚µ)
          if ! command -v nginx &> /dev/null; then
            sudo apt update
            sudo apt install -y nginx
          fi
          
          # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
          sudo tee /etc/nginx/sites-available/frontend > /dev/null <<EOF
          server {
              listen 80;
              server_name 134.185.106.160;
              
              root /var/www/frontend/dist;
              index index.html;
              
              location / {
                  try_files \$uri \$uri/ /index.html;
              }
              
              # ì •ì  íŒŒì¼ ìºì‹±
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
          EOF
          
          # ì‚¬ì´íŠ¸ í™œì„±í™”
          sudo ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/
          
          # ê¸°ë³¸ ì‚¬ì´íŠ¸ ë¹„í™œì„±í™”
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ìž¬ì‹œìž‘
          sudo nginx -t && sudo systemctl reload nginx
          sudo systemctl enable nginx
          
    - name: Deployment Status
      run: |
        echo "ðŸš€ Deployment completed successfully!"
        echo "ðŸŒ Frontend is now live at: http://134.185.106.160"