name: Deploy Full Stack

on:
  push:
    branches: ["main", "develop"]

jobs:
  # ===================================================================
  #  Job 1: ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  # ===================================================================
  build-backend:
    runs-on: ubuntu-latest
    if: |
      (contains(github.ref, 'main') || contains(github.ref, 'develop')) &&
      (contains(github.event.head_commit.modified, 'back/') || 
       contains(github.event.head_commit.added, 'back/') ||
       contains(github.event.head_commit.modified, 'ai/') ||
       contains(github.event.head_commit.added, 'ai/'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: hy7012
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: |
            hy7012/pls-jober-backend:latest
            hy7012/pls-jober-backend:${{ github.ref_name }}

  # ===================================================================
  #  Job 2: í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
  # ===================================================================
  build-frontend:
    runs-on: ubuntu-latest
    if: |
      (contains(github.ref, 'main') || contains(github.ref, 'develop')) &&
      (contains(github.event.head_commit.modified, 'front/') || 
       contains(github.event.head_commit.added, 'front/'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json
          
      - name: Install dependencies
        working-directory: ./front
        run: npm ci
        
      - name: Run type check
        working-directory: ./front
        run: npm run type-check
        
      - name: Run linter
        working-directory: ./front
        run: npm run lint || echo "ESLint warnings/errors found but continuing deployment"
        
      - name: Build application
        working-directory: ./front
        run: npm run build

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/
          retention-days: 1

  # ===================================================================
  #  Job 3: ë°±ì—”ë“œ ë°°í¬
  # ===================================================================
  deploy-backend:
    needs: build-backend
    runs-on: ubuntu-latest
    if: needs.build-backend.result == 'success'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Deploy backend to Oracle Cloud VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 134.185.106.160
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE }}
          script: |
            # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ pull
            docker pull hy7012/pls-jober-backend:latest
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì‚­ì œ(ì—†ìœ¼ë©´ ë¬´ì‹œ)
            docker rm -f pls-jober-container || true
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„œë²„ì— ë¯¸ë¦¬ ìƒì„±í•´ë‘” .env íŒŒì¼ ì‚¬ìš©)
            docker run -d -p 8080:8080 --env-file /home/ubuntu/.env --name pls-jober-container --restart unless-stopped hy7012/pls-jober-backend:latest
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            docker image prune -f
            echo "Backend deployment complete."

  # ===================================================================
  #  Job 4: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
  # ===================================================================
  deploy-frontend:
    needs: build-frontend
    runs-on: ubuntu-latest
    if: needs.build-frontend.result == 'success'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Download frontend build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: front/dist/

      - name: Deploy frontend to Oracle Cloud Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 134.185.106.160
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE }}
          port: 22
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /var/www/frontend
            sudo chown -R $USER:$USER /var/www/frontend
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d "/var/www/frontend/backup" ]; then
              sudo rm -rf /var/www/frontend/backup
            fi
            if [ -d "/var/www/frontend/dist" ]; then
              sudo mv /var/www/frontend/dist /var/www/frontend/backup
            fi
            
            # ìƒˆë¡œìš´ ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /var/www/frontend/dist

      - name: Copy build files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 134.185.106.160
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE }}
          port: 22
          source: "front/dist/**"
          target: "/var/www/frontend/dist/"

      - name: Setup Nginx (if not already configured)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 134.185.106.160
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE }}
          port: 22
          script: |
            # Nginx ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìœ¼ë©´ ìŠ¤í‚µ)
            if ! command -v nginx &> /dev/null; then
              sudo apt update
              sudo apt install -y nginx
            fi
            
            # Nginx ì„¤ì • íŒŒì¼ ìƒì„±
            sudo tee /etc/nginx/sites-available/frontend > /dev/null <<'EOF'
            server {
                listen 80;
                server_name 134.185.106.160;
                
                root /var/www/frontend/dist;
                index index.html;
                
                location / {
                    try_files $uri $uri/ /index.html;
                }
                
                # ì •ì  íŒŒì¼ ìºì‹±
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            EOF
            
            # ì‚¬ì´íŠ¸ í™œì„±í™”
            sudo ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/
            
            # ê¸°ë³¸ ì‚¬ì´íŠ¸ ë¹„í™œì„±í™”
            sudo rm -f /etc/nginx/sites-enabled/default

            # íŒŒì¼ ê¶Œí•œ ì„¤ì •
            sudo chown -R www-data:www-data /var/www/frontend/
            sudo chmod -R 755 /var/www/frontend/
            sudo systemctl reload nginx

  # ===================================================================
  #  Job 5: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  # ===================================================================
  deployment-status:
    needs: [build-backend, build-frontend, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always() && (needs.build-backend.result != 'skipped' || needs.build-frontend.result != 'skipped')
    steps:
      - name: Deployment Status
        run: |
          echo "ðŸ“Š Deployment Summary:"
          echo "Backend build: ${{ needs.build-backend.result }}"
          echo "Frontend build: ${{ needs.build-frontend.result }}"
          echo "Backend deploy: ${{ needs.deploy-backend.result }}"
          echo "Frontend deploy: ${{ needs.deploy-frontend.result }}"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"
          
          if [[ "${{ needs.deploy-backend.result }}" == "success" || "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            echo "ðŸš€ Deployment completed successfully!"
            if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
              echo "ðŸŒ Frontend: http://134.185.106.160"
            fi
            if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
              echo "ðŸ”§ Backend API: http://134.185.106.160:8080"
            fi
          else
            echo "âŒ No deployments were executed (no changes detected)"
          fi
