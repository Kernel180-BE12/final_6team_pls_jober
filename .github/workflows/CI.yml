name: CI

on:
  pull_request:
    branches: ["main", "develop"]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      front: ${{ steps.filter.outputs.front }}
      ai: ${{ steps.filter.outputs.ai }}
      back: ${{ steps.filter.outputs.back }}
      root: ${{ steps.filter.outputs.root }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            front:
              - 'front/**'
            ai:
              - 'ai/**'
            back:
              - 'back/**'
            root:
              - '*'
              - '.github/**'

  node-build:
    needs: changes
    if: ${{ needs.changes.outputs.front == 'true' || needs.changes.outputs.root == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./front
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ./front/package-lock.json
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test --if-present

  python-build:
    needs: changes
    if: ${{ needs.changes.outputs.ai == 'true' || needs.changes.outputs.root == 'true' }}
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'ai/')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ai/requirements.txt
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      - name: Test with pytest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pytest ai/tests || echo "⚠️ 테스트가 없습니다. (pytest exit code 5)"

  java-build:
    needs: changes
    if: ${{ needs.changes.outputs.back == 'true' || needs.changes.outputs.root == 'true' }}
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'back/')
    defaults:
      run:
        working-directory: back
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Build with Gradle Wrapper
        run: ./gradlew build

  dependency-submission:
    needs: changes
    if: ${{ needs.changes.outputs.back == 'true' || needs.changes.outputs.root == 'true' }}
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'back/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@af1da67850ed9a4cedd57bfd976089dd991e2582
        with:
          build-root-directory: back
